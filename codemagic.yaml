workflows:
  telegram-ui-only:
    name: Telegram UI-Only Simulator
    max_build_duration: 120

    environment:
      vars:
        APP_URL: https://github.com/Gringo2/Telegram-iOS/releases/download/ui-only-build-31965/Telegram.app.zip
        # Specify the iOS version to use (e.g., "17.0", "17.2"). Leave empty to use the default for the selected Xcode version.
        IOS_VERSION: "13.0" 
      xcode: latest

    scripts:
      - name: Download Telegram UI-Only build
        script: |
          echo "Downloading Telegram UI-Only build..."
          curl -L "$APP_URL" -o Telegram.app.zip
          unzip Telegram.app.zip
          ls -l Telegram.app

      - name: Boot iOS Simulator
        script: |
          echo "Shutting down all simulators..."
          xcrun simctl shutdown all || true

          DEVICE_NAME="iPhone 15"
          DEVICE_TYPE_ID="iPhone 15" # Default devicetype

          echo "Available runtimes:"
          xcrun simctl list runtimes

          if [ -n "$IOS_VERSION" ]; then
              echo "Attempting to boot $DEVICE_NAME with iOS $IOS_VERSION..."
              
              # Find the runtime identifier (e.g., com.apple.CoreSimulator.SimRuntime.iOS-17-2)
              # Matches lines like "iOS 17.2 (21C62) - com.apple.CoreSimulator.SimRuntime.iOS-17-2"
              RUNTIME_ID=$(xcrun simctl list runtimes | grep -i "iOS $IOS_VERSION" | awk 'END{print $NF}')

              if [ -z "$RUNTIME_ID" ]; then
                  echo "ERROR: Could not find a runtime matching 'iOS $IOS_VERSION'."
                  echo "Please check the available runtimes listed above or update the 'xcode' environment version."
                  exit 1
              fi
              
              echo "Found runtime: $RUNTIME_ID"
              
              # Create a new simulator with this runtime
              # We use a unique name to avoid conflicts if needed, or just standard name
              TIMESTAMP=$(date +%s)
              CUSTOM_DEVICE_NAME="${DEVICE_NAME}_${IOS_VERSION}_${TIMESTAMP}"
              
              echo "Creating simulator '$CUSTOM_DEVICE_NAME'..."
              UUID=$(xcrun simctl create "$CUSTOM_DEVICE_NAME" "$DEVICE_TYPE_ID" "$RUNTIME_ID")
              
              echo "Booting simulator $UUID..."
              xcrun simctl boot "$UUID"
          else
              echo "IOS_VERSION not specified. Booting default '$DEVICE_NAME'..."
              # Attempt to boot existing "iPhone 15" or create if missing (default runtime)
              
              # Check if device exists
              if ! xcrun simctl list devices | grep -q "$DEVICE_NAME"; then
                 echo "Device '$DEVICE_NAME' not found, creating..."
                 xcrun simctl create "$DEVICE_NAME" "$DEVICE_TYPE_ID"
              fi
              
              xcrun simctl boot "$DEVICE_NAME"
          fi

          open -a Simulator

          echo "Waiting for simulator to fully boot..."
          until xcrun simctl list | grep -q "Booted"; do
              sleep 5
          done
          echo "Simulator is ready."

      - name: Install and launch Telegram UI-Only
        script: |
          # Optional safety check
          INFO_PLIST="Telegram.app/Info.plist"
          if [ ! -f "$INFO_PLIST" ]; then
            echo "ERROR: Info.plist not found at $INFO_PLIST"
            exit 1
          fi

          echo "Installing Telegram UI-Only build..."
          xcrun simctl install booted Telegram.app

          echo "Launching Telegram UI-Only..."
          xcrun simctl launch booted org.telegram.Telegram
